package job_build_for_docker

@Library("devops@job_build_for_docker")
import hyperpaint.util.Regex
import hyperpaint.util.Shell
import hyperpaint.util.Util

Shell.setJenkins(this)

/* Получение параметров, проверка и назначение значений по-умолчанию */
/** Выбирать последние версии автоматически */
Boolean useLatestVersion = params.use_latest_version
Boolean useLatestVersionDefault = false
String useLatestVersionDescription = "Выбирать последние версии автоматически"
/** Использовать кэш загрузок */
Boolean useCacheFile = params.use_cache_file
Boolean useCacheFileDefault = true
String useCacheFileDescription = "Использовать кэш загрузок"
/** Использовать кэш сборок */
Boolean useCacheDocker = params.use_cache_docker
Boolean useCacheDockerDefault = true
String useCacheDockerDescription = "Использовать кэш сборок"
/** Деплой и проверка состояния контейнера */
Boolean deployImage = params.deploy_image
Boolean deployImageDefault = true
String deployImageDescription = "Деплой и проверка состояния контейнера"
/** Экспортировать образ */
Boolean exportImage = params.export_image
Boolean exportImageDefault = false
String exportImageDescription = "Экспортировать образ"
/** Удалить образ */
Boolean deleteImage = params.delete_image
Boolean deleteImageDefault = false
String deleteImageDescription = "Удалить образ"

/* Получение переменных окружения */
String hostCredentials = env.host_credentials
String sshCredentials = env.ssh_credentials
String dockerComposeProjectDirectory = env.docker_compose_project_directory

/** Docker image name */
String imageName = env.image_name

/** URL на страницу с релизами или дистрибутив */
String appUrl = env.app_url
/** Инвертировать список ссылок */
Boolean appUrlReverse = env.app_url_reverse.toBoolean()
/** Количество регулярных выражений для отбора ссылок */
Integer appDistributiveUrlRegexCount = env.app_distributive_url_regex_count.toInteger()

String themesDirectory = env.themes_directory
/** Количество плагинов */
Integer themesCount = env.themes_count.toInteger()
/** Инвертировать список ссылок */
Boolean themeUrlReverse = env.theme_url_reverse.toBoolean()
/** Количество регулярных выражений для отбора ссылок */
Integer themeDistributiveUrlRegexCount = env.theme_distributive_url_regex_count

String pluginsDirectory = env.plugins_directory
/** Количество плагинов */
Integer pluginsCount = env.plugins_count.toInteger()
/** Инвертировать список ссылок */
Boolean pluginUrlReverse = env.plugin_url_reverse.toBoolean()
/** Количество регулярных выражений для отбора ссылок */
Integer pluginDistributiveUrlRegexCount = env.plugin_distributive_url_regex_count

/* Константы */
int cacheLifetime = 86400
String buildDirectory = "build-directory"

pipeline {
    agent any
    parameters {
        booleanParam(name: "use_latest_version", defaultValue: useLatestVersionDefault, description: useLatestVersionDescription)
        booleanParam(name: "use_cache_file", defaultValue: useCacheFileDefault, description: useCacheFileDescription)
        booleanParam(name: "use_cache_docker", defaultValue: useCacheDockerDefault, description: useCacheDockerDescription)
        booleanParam(name: "deploy_image", defaultValue: deployImageDefault, description: deployImageDescription)
        booleanParam(name: "export_image", defaultValue: exportImageDefault, description: exportImageDescription)
        booleanParam(name: "delete_image", defaultValue: deleteImageDefault, description: deleteImageDescription)
    }
    options {
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    stages {
        stage("Параметры и переменные окружения") {
            steps {
                script {
                    /* Задание стандартных параметров */
                    String noParamString = "Параметр '%s' не задан, использую стандартное значение '%s'"

                    if (useLatestVersion == null) {
                        useLatestVersion = true
                        Shell.echo(String.format(noParamString, "use_latest_version", useLatestVersion.toString()))
                    }
                    if (useCacheFile == null) {
                        useCacheFile = true
                        Shell.echo(String.format(noParamString, "use_cache_file", useCacheFile.toString()))
                    }
                    if (useCacheDocker == null) {
                        useCacheDocker = true
                        Shell.echo(String.format(noParamString, "use_cache_docker", useCacheDocker.toString()))
                    }
                    if (deployImage == null) {
                        deployImage = true
                        Shell.echo(String.format(noParamString, "deploy_image", deployImage.toString()))
                    }
                    if (exportImage == null) {
                        exportImage = true
                        Shell.echo(String.format(noParamString, "export_image", exportImage.toString()))
                    }
                    if (deleteImage == null) {
                        deleteImage = true
                        Shell.echo(String.format(noParamString, "delete_image", deleteImage.toString()))
                    }

                    /* Проверка переменных окружения */
                    /* Проверка необязательных переменных окружения */
                    String noEnvStringContinue = "Переменная окружения '%s' не задана, использую стандартное значение '%s'"
                    /* Проверка обязательных переменных окружения */
                    String noEnvStringError = "Переменная окружения '%s' не задана, выполнение невозможно"

                    if (hostCredentials == null) {
                        Shell.error(String.format(noEnvStringError, "host_credentials"))
                    }

                    if (sshCredentials == null) {
                        Shell.error(String.format(noEnvStringError, "ssh_credentials"))
                    }

                    if (dockerComposeProjectDirectory == null) {
                        Shell.error(String.format(noEnvStringError, "docker_compose_project_directory"))
                    }

                    if (imageName == null) {
                        Shell.error(String.format(noEnvStringError, "image_name"))
                    }

                    if (appUrl == null) {
                        Shell.error(String.format(noEnvStringError, "app_url"))
                    }

                    if (appUrlReverse == null) {
                        appUrlReverse = false
                        Shell.echo(String.format(noEnvStringContinue, "app_url_reverse", appUrlReverse))
                    }

                    if (appDistributiveUrlRegexCount == null) {
                        appDistributiveUrlRegexCount = 0
                        Shell.echo(String.format(noEnvStringContinue, "app_distributive_url_regex_count", appDistributiveUrlRegexCount))
                    } else if (appDistributiveUrlRegexCount != 0) {
                        for (int i = 1; i <= appDistributiveUrlRegexCount; i++) {
                            if (env["app_distributive_url_regex${i}"] == null) {
                                Shell.error(String.format(noEnvStringError, "app_distributive_url_regex${i}"))
                            }
                        }
                    }

                    if (themesCount == null) {
                        themesCount = 0
                        Shell.echo(String.format(noEnvStringContinue, "themes_count", themesCount.toString()))
                    } else if (themesCount != 0) {
                        if (themesDirectory == null) {
                            Shell.error(String.format(noEnvStringError, "themes_directory"))
                        }

                        for (int i = 1; i <= themesCount; i++) {
                            assert(env["theme_url${i}"] != null)
                        }

                        if (themeUrlReverse == null) {
                            themeUrlReverse = false
                            Shell.echo(String.format(noEnvStringContinue, "theme_url_reverse", themeUrlReverse))
                        }

                        if (themeDistributiveUrlRegexCount == null) {
                            themeDistributiveUrlRegexCount = 0
                            Shell.echo(String.format(noEnvStringContinue, "theme_distributive_url_regex_count", themeDistributiveUrlRegexCount))
                        } else if (themeDistributiveUrlRegexCount != 0) {
                            for (int i = 1; i <= themeDistributiveUrlRegexCount; i++) {
                                if (env["theme_distributive_url_regex${i}"] == null) {
                                    Shell.error(String.format(noEnvStringError, "theme_distributive_url_regex${i}"))
                                }
                            }
                        }
                    }

                    if (pluginsCount == null) {
                        pluginsCount = 0
                        Shell.echo(String.format(noEnvStringContinue, "plugins_count", pluginsCount.toString()))
                    } else if (pluginsCount != 0) {
                        if (pluginsDirectory == null) {
                            Shell.error(String.format(noEnvStringError, "plugins_directory"))
                        }

                        for (int i = 1; i <= pluginsCount; i++) {
                            assert(env["plugin_url${i}"] != null)
                        }

                        if (pluginUrlReverse == null) {
                            pluginUrlReverse = false
                            Shell.echo(String.format(noEnvStringContinue, "plugin_url_reverse", pluginUrlReverse))
                        }

                        if (pluginDistributiveUrlRegexCount == null) {
                            pluginDistributiveUrlRegexCount = 0
                            Shell.echo(String.format(noEnvStringContinue, "plugin_distributive_url_regex_count", pluginDistributiveUrlRegexCount))
                        } else if (pluginDistributiveUrlRegexCount != 0) {
                            for (int i = 1; i <= pluginDistributiveUrlRegexCount; i++) {
                                if (env["plugin_distributive_url_regex${i}"] == null) {
                                    Shell.error(String.format(noEnvStringError, "plugin_distributive_url_regex${i}"))
                                }
                            }
                        }
                    }
                }
            }
        }
        stage("Получаю дистрибутив") {
            steps {
                script {
                    /* Распарсить параметры из ссылки */
                    Boolean isReleasesPage = Regex.find(appUrl, "[\\?\\&]is_releases_page=1")
                    if (isReleasesPage) {
                        Shell.echo("${appUrl} - Страница HTML с ссылками")
                    }
                    Boolean isDistributive = Regex.find(appUrl, "[\\?\\&]is_distributive=1")
                    Boolean isFileNameDefined = Regex.find(appUrl, "[\\?\\&]file_name=([A-Za-z0-9\\-_\\.])")
                    if (isDistributive && !isReleasesPage) {
                        if (isFileNameDefined) {
                            Shell.echo("${appUrl} - Архив дистрибутива с именем")
                        } else {
                            Shell.echo("${appUrl} - Архив дистрибутива")
                        }
                    }

                    Runnable releasesPageRunnable = {
                        if (useCacheFile) Util.downloadFile(appUrl, "releases.html", cacheLifetime) else Util.downloadFile(appUrl, "releases.html", -1)

                        /* Найти на странице с релизами все ссылки href с тегом <a> */
                        String releasesHTML = readFile("releases.html")
                        List<String> urlsList = Regex.groupAll(releasesHTML, "<a[A-Za-z0-9\\-_\\.\\s]*href\\s*=\\s*\"([A-Za-z0-9\\-_\\.]+)\"[A-Za-z0-9\\-_\\.\\s]*>")

                        /* Преобразование относительных ссылок в абсолютные */
                        Shell.echo("Преобразовываю относительные ссылки в абсолютные")
                        List<String> absoluteUrlsList = new ArrayList<>()
                        int size = urlsList.size()
                        for (int i = 0; i < size; i++) {
                            String currentUrl = urlsList.get(i)
                            if (Regex.find(currentUrl, "^(\\.\\/){0,1}[A-Za-z0-9\\-_\\.]+\$")) {
                                /* Относительная ссылка */
                                absoluteUrlsList.add(appUrl + currentUrl)
                            } else {
                                /* Абсолютная ссылка */
                                absoluteUrlsList.add(currentUrl)
                            }
                        }

                        /* Отобрать только те ссылки, которые подходят по регулярному выражению */
                        /* Но сначала создать массив регулярных выражений */
                        Shell.echo("Отбираю ссылки, которые подходят по регулярному выражению")
                        String[] regexArray = new String[appDistributiveUrlRegexCount]
                        for (int i = 0; i < appDistributiveUrlRegexCount; i++) {
                            regexArray[i] = env["app_distributive_url_regex${i}"]
                        }
                        urlsList.clear()
                        size = absoluteUrlsList.size()
                        for (int i = 0; i < size; i++) {
                            String currentUrl = absoluteUrlsList.get(i)

                            Boolean success = true
                            for (int regex = 0; i < appDistributiveUrlRegexCount; regex++) {
                                if (!Regex.find(currentUrl, regexArray[regex])) {
                                    success = false
                                    break
                                }
                            }

                            if (success) {
                                // Подходящая ссылка
                                if (!urlsList.contains(currentUrl)) {
                                    // Уникальная ссылка
                                    urlsList.add(currentUrl)
                                }
                            }
                        }

                        /* Инвертирование списка */
                        if (appUrlReverse) {
                            Shell.echo("Инвертирую список")
                            urlsList = urlsList.reverse()
                        }

                        /* Если ссылок несколько, то запросить ввод */
                        String downloadUrl = null
                        size = urlsList.size()
                        if (size == 0) {
                            Shell.error("Найдено ${size} ссылок")
                        } else {
                            Shell.echo("Найдено ${size} ссылок")
                            if (size == 1) {
                                downloadUrl = urlsList.get(0)
                            } else {
                                downloadUrl = input(message: "Выбор версии ${appUrl}", parameters: [choice(name: "Версия", choices: urlsList.join('\n'))]).toString()
                            }
                        }

                        /* Скачать дистрибутив */
                        String fileName
                        if (isFileNameDefined) {
                            fileName = Regex.group(downloadUrl, "[\\?\\&]file_name=([A-Za-z0-9\\-_\\.])")
                        } else {
                            fileName = Regex.group(downloadUrl, ".+\\/(.+)\$")
                        }
                        if (useCacheFile) Util.downloadFile(downloadUrl, fileName) else Util.downloadFile(downloadUrl, fileName, -1)
                        Util.unarchiveFile(fileName, buildDirectory, true)
                    }

                    Runnable distributiveRunnable = {
                        /* Скачать дистрибутив */
                        String downloadUrl = appUrl
                        String fileName
                        if (isFileNameDefined) {
                            fileName = Regex.group(downloadUrl, "[\\?\\&]file_name=([A-Za-z0-9\\-_\\.])")
                        } else {
                            fileName = Regex.group(downloadUrl, ".+\\/(.+)\$")
                        }
                        if (useCacheFile) Util.downloadFile(downloadUrl, fileName) else Util.downloadFile(downloadUrl, fileName, -1)
                        Util.unarchiveFile(fileName, buildDirectory, true)
                    }

                    if (isReleasesPage) {
                        releasesPageRunnable.run()
                    } else if (isDistributive) {
                        distributiveRunnable.run()
                    } else {
                        releasesPageRunnable.run()
                    }
                }
            }
        }
    }
}
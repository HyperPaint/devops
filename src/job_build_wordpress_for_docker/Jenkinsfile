package job_build_wordpress_for_docker

@Library("devops@build_wordpress_for_docker")
import hyperpaint.util.Docker
import hyperpaint.util.DockerCompose
import hyperpaint.util.Shell

import java.util.regex.Matcher

Shell.setJenkins(this)

boolean useCache = params.use_cache
boolean testImage = params.test_image
boolean exportImage = params.export_image
boolean deleteImage = params.delete_image

String hostCredentials = env.host_credentials
String sshCredentials = env.ssh_credentials
String dockerComposeProjectDirectory = env.docker_compose_project_directory

String wordpressReleaseUrlPattern = env.wordpress_url_pattern
String wordpressReleaseNamePattern = env.wordpress_name_pattern
String wordpressReleaseFileNamePattern = env.wordpress_file_name_pattern

String themeReleaseUrlPattern = env.theme_url_pattern
String themeReleaseNamePattern = env.theme_name_pattern
String themeReleaseFileNamePattern = env.theme_file_name_pattern

String pluginReleaseUrlPattern = env.plugin_url_pattern
String pluginReleaseNamePattern = env.plugin_name_pattern
String pluginReleaseFileNamePattern = env.plugin_file_name_pattern

String imageName = "blog"
String imageVersion = null
String imageFullName = null

// Сутки
int cacheLifetime = 86400

String releasesFile = "releases"
String wordpressReleasesFileName = "${releasesFile}-wordpress.html"
String themeReleasesFileName = "${releasesFile}-theme-%s.html"
String pluginReleasesFileName = "${releasesFile}-plugin-%s.html"

// Ссылка на дистрибутив
String wordpressChosenReleaseUrl = null
// Имя дистрибутива и директория дистрибутива
String wordpressChosenReleaseName = null
// Файл дистрибутива
String wordpressChosenReleaseFileName = null

static boolean regexFind(String text, String regex) {
    Matcher matcher = (text =~ regex)
    return matcher.find()
}

static String regexGroup(String text, String regex) {
    Matcher matcher = (text =~ regex)
    matcher.find()
    try {
        return matcher.group(1)
    }
    catch (IllegalStateException ignored) {
        error("Не удалось найти совпадение по регулярному выражению ${regex}\n${text}")
    }
    catch (IndexOutOfBoundsException ignored) {
        error("Не удалось найти группу по регулярному выражению ${regex}\n${text}")
    }
}

static void downloadFile(String url, String file, Integer cacheLifetime = Integer.MAX_VALUE) {
    // Поиск существующего файла
    Integer fileModifiedXSecondsAgo = Integer.MAX_VALUE
    if (Shell.shWithStatus("[[ -f '${file}' ]]")) {
        fileModifiedXSecondsAgo = Shell.shWithOutput("echo \"\$(date +%s)-\$(date -r '${file}' +%s)\" | bc").toInteger()
    }

    // Проверка актуальности файла
    if (fileModifiedXSecondsAgo >= cacheLifetime) {
        Shell.echo("Скачиваю файл ${file}")
        Shell.shOrFail("wget -O '${file}' '${url}'")
    } else {
        Shell.echo("Пропускаю скачивание файла ${file}")
    }
}

static List<String> searchText(String file, String regex) {
    String releaseLinksBuff = Shell.shWithOutput("grep -ioE '${regex}' '${file}' | uniq | sort -r")
    List<String> releaseUrls = new ArrayList<>()
    releaseUrls.addAll(releaseLinksBuff.split('\n'))
    releaseUrls.remove('')
    return releaseUrls
}

//noinspection GroovyAssignabilityCheck
pipeline {
    agent any
    parameters {
        booleanParam(name: "use_cache", defaultValue: true, description: "Использовать кэш")
        booleanParam(name: "test_image", defaultValue: true, description: "Тестировать образ")
        booleanParam(name: "export_image", defaultValue: false, description: "Экспортировать образ")
        booleanParam(name: "delete_image", defaultValue: false, description: "Удалить образ после сборки")
    }
    stages {
        stage("Получаю WordPress") {
            steps {
                script {
                    echo("Проверяю доступные версии WordPress...")
                    String wordpressReleasesUrl = env.wordpress
                    // Ссылка на дистрибутив или список версий?
                    if (regexFind(wordpressReleasesUrl, wordpressReleaseUrlPattern)) {
                        echo("Найдено 1 версий WordPress")
                        wordpressChosenReleaseUrl = wordpressReleasesUrl
                        wordpressChosenReleaseName = regexGroup(wordpressChosenReleaseUrl, wordpressReleaseNamePattern)
                        wordpressChosenReleaseFileName = regexGroup(wordpressChosenReleaseUrl, wordpressReleaseFileNamePattern)
                    } else {
                        echo("Найден список версий WordPress")
                        // Получить файл релизов
                        if (useCache) {
                            downloadFile(wordpressReleasesUrl, wordpressReleasesFileName, cacheLifetime)
                        } else {
                            downloadFile(wordpressReleasesUrl, wordpressReleasesFileName, -1)
                        }

                        // Поиск версий в файле
                        List<String> releaseUrls = searchText(wordpressReleasesFileName, wordpressReleaseUrlPattern)
                        if (releaseUrls.size()) {
                            echo("Найдено ${releaseUrls.size()} версий WordPress")
                            if (releaseUrls.size() == 1) {
                                wordpressChosenReleaseUrl = releaseUrls.get(0)
                            } else {
                                wordpressChosenReleaseUrl = input(message: "Выбор версии WordPress", parameters: [choice(name: "Версия WordPress", choices: releaseUrls.join('\n'))]).toString()
                            }
                        } else {
                            error("Найдено ${releaseUrls.size()} версий WordPress")
                        }
                    }

                    wordpressChosenReleaseName = regexGroup(wordpressChosenReleaseUrl, wordpressReleaseNamePattern)
                    wordpressChosenReleaseFileName = regexGroup(wordpressChosenReleaseUrl, wordpressReleaseFileNamePattern)
                    if (useCache) {
                        downloadFile(wordpressChosenReleaseUrl, wordpressChosenReleaseFileName)
                    } else {
                        downloadFile(wordpressChosenReleaseUrl, wordpressChosenReleaseFileName, -1)
                    }

                    echo("Распаковываю WordPress...")
                    if (Shell.shWithStatus("[[ -d '${wordpressChosenReleaseName}' ]]")) {
                        Shell.shOrFail("rm -rf '${wordpressChosenReleaseName}'")
                    }
                    Shell.shOrFail("mkdir -v '${wordpressChosenReleaseName}'")
                    Shell.shOrFail("tar x -zf '${wordpressChosenReleaseFileName}' -C '${wordpressChosenReleaseName}'")
                }
            }
        }
        stage('Получить темы') {
            steps {
                echo("Удаляю предустановленные темы WordPress...")
                Shell.shOrFail("cd \"${wordpressChosenReleaseName}/wordpress/wp-content/themes/\" && rm -rf \$(ls | grep -v \"index.php\")")

                echo("Проверяю доступные версии тем WordPress...")
                script {
                    String currentName
                    String currentReleasesUrl
                    String currentReleasesFileName
                    String chosenReleaseUrl = null
                    String chosenReleaseFileName
                    List<String> releaseUrls
                    int size = Integer.valueOf(env.themes)
                    for (int i = 1; i <= size; i++) {
                        currentReleasesUrl = env["theme" + i.toString()]
                        currentName = regexGroup(currentReleasesUrl, themeReleaseNamePattern)

                        echo("Проверяю доступные версии ${currentName}...")
                        // Ссылка на дистрибутив или список версий?
                        if (regexFind(currentReleasesUrl, themeReleaseUrlPattern)) {
                            echo("Найдено 1 версий ${currentName}")
                            chosenReleaseUrl = currentReleasesUrl
                        } else {
                            // Получить файл релизов
                            echo("Найден список версий ${currentName}")
                            currentReleasesFileName = String.format(themeReleasesFileName, currentName)
                            if (useCache) {
                                downloadFile(currentReleasesUrl, currentReleasesFileName, cacheLifetime)
                            } else {
                                downloadFile(currentReleasesUrl, currentReleasesFileName, -1)
                            }

                            // Поиск версий в файле
                            releaseUrls = searchText(currentReleasesFileName, String.format(themeReleaseUrlPattern, currentName))
                            if (releaseUrls.size()) {
                                // Выбор версии
                                echo("Найдено ${releaseUrls.size()} версий ${currentName}")
                                if (releaseUrls.size() == 1) {
                                    chosenReleaseUrl = releaseUrls.get(0)
                                } else {
                                    chosenReleaseUrl = input(message: "Выбор версии ${currentName}".toString(), parameters: [choice(name: "Версия ${currentName}", choices: releaseUrls.join('\n'))]).toString()
                                }
                            } else {
                                echo("Найдено ${releaseUrls.size()} версий ${currentName}")
                            }
                        }

                        chosenReleaseFileName = regexGroup(chosenReleaseUrl, String.format(themeReleaseFileNamePattern, currentName))
                        if (useCache) {
                            downloadFile(chosenReleaseUrl, chosenReleaseFileName)
                        } else {
                            downloadFile(chosenReleaseUrl, chosenReleaseFileName, -1)
                        }

                        echo("Распаковываю ${currentName}...")
                        Shell.shOrFail("unzip -q '${chosenReleaseFileName}' -d '${wordpressChosenReleaseName}/wordpress/wp-content/themes/'")
                    }
                }
            }
        }
        stage("Получить плагины") {
            steps {
                echo("Удаляю предустановленные плагины WordPress...")
                Shell.shOrFail("cd \"${wordpressChosenReleaseName}/wordpress/wp-content/plugins/\" && rm -rf \$(ls | grep -v \"index.php\")")

                echo("Проверяю доступные версии плагинов WordPress...")
                script {
                    String currentName
                    String currentReleasesUrl
                    String currentReleasesFileName
                    String chosenReleaseUrl = null
                    String chosenReleaseFileName
                    List<String> releaseUrls
                    int size = Integer.valueOf(env.plugins)
                    for (int i = 1; i <= size; i++) {
                        currentReleasesUrl = env["plugin" + i.toString()]
                        currentName = regexGroup(currentReleasesUrl, pluginReleaseNamePattern)

                        echo("Проверяю доступные версии ${currentName}...")
                        // Ссылка на дистрибутив или список версий?
                        if (regexFind(currentReleasesUrl, pluginReleaseUrlPattern)) {
                            echo("Найдено 1 версий ${currentName}")
                            chosenReleaseUrl = currentReleasesUrl
                        } else {
                            // Получить файл релизов
                            echo("Найден список версий ${currentName}")
                            currentReleasesFileName = String.format(pluginReleasesFileName, currentName)
                            if (useCache) {
                                downloadFile(currentReleasesUrl, currentReleasesFileName, cacheLifetime)
                            } else {
                                downloadFile(currentReleasesUrl, currentReleasesFileName, -1)
                            }

                            // Поиск версий в файле
                            releaseUrls = searchText(currentReleasesFileName, String.format(pluginReleaseUrlPattern, currentName))
                            if (releaseUrls.size()) {
                                // Выбор версии
                                echo("Найдено ${releaseUrls.size()} версий ${currentName}")
                                if (releaseUrls.size() == 1) {
                                    chosenReleaseUrl = releaseUrls.get(0)
                                } else {
                                    chosenReleaseUrl = input(message: "Выбор версии ${currentName}".toString(), parameters: [choice(name: "Версия ${currentName}", choices: releaseUrls.join('\n'))]).toString()
                                }
                            } else {
                                echo("Найдено ${releaseUrls.size()} версий ${currentName}")
                            }
                        }

                        chosenReleaseFileName = regexGroup(chosenReleaseUrl, String.format(pluginReleaseFileNamePattern, currentName))
                        if (useCache) {
                            downloadFile(chosenReleaseUrl, chosenReleaseFileName)
                        } else {
                            downloadFile(chosenReleaseUrl, chosenReleaseFileName, -1)
                        }

                        echo("Распаковываю ${currentName}...")
                        Shell.shOrFail("unzip -q '${chosenReleaseFileName}' -d '${wordpressChosenReleaseName}/wordpress/wp-content/plugins/'")
                    }
                }
            }
        }
        stage('Настроить WordPress') {
            steps {
                echo("Настраиваю WordPress...")
                String file = "${wordpressChosenReleaseName}/wordpress/wp-config-sample.php"
                // Добавить дополнительную конфигурацию в начало файла с заменой <?php
                Shell.shOrFail("sed -i 's/<?php//g' '${file}'")
                Shell.shOrFail("cat \"job_build_wordpress_for_docker/src/wordpress/wp-config.php\" \"${file}'\" | tee \"${file}'\" 1>/dev/null")
                // Параметризовать файл - параметры базы данных
                Shell.shOrFail("sed -i \"s/define( 'DB_NAME', 'database_name_here' );/define( 'DB_NAME', '\\\$DB_NAME' );/g\" \"${file}'\"")
                Shell.shOrFail("sed -i \"s/define( 'DB_USER', 'username_here' );/define( 'DB_USER', '\\\$DB_USER' );/g\" \"${file}'\"")
                Shell.shOrFail("sed -i \"s/define( 'DB_PASSWORD', 'password_here' );/define( 'DB_PASSWORD', '\\\$DB_PASSWORD' );/g\" \"${file}'\"")
                Shell.shOrFail("sed -i \"s/define( 'DB_HOST', 'localhost' );/define( 'DB_HOST', '\\\$DB_HOST' );/g\" \"${file}'\"")
                Shell.shOrFail("sed -i \"s/define( 'DB_CHARSET', 'utf8' );/define( 'DB_CHARSET', '\\\$DB_CHARSET' );/g\" \"${file}'\"")
                Shell.shOrFail("sed -i \"s/define( 'DB_COLLATE', '' );/define( 'DB_COLLATE', '\\\$DB_COLLATE' );/g\" \"${file}'\"")
                // Параметризовать файл - уникальные ключи и соли для аутентификации
                Shell.shOrFail("sed -i \"s/define( 'AUTH_KEY',\\s*'put your unique phrase here' );/define( 'AUTH_KEY', '\\\$AUTH_KEY' );/g\" \"${file}'\"")
                Shell.shOrFail("sed -i \"s/define( 'SECURE_AUTH_KEY',\\s*'put your unique phrase here' );/define( 'SECURE_AUTH_KEY', '\\\$SECURE_AUTH_KEY' );/g\" \"${file}'\"")
                Shell.shOrFail("sed -i \"s/define( 'LOGGED_IN_KEY',\\s*'put your unique phrase here' );/define( 'LOGGED_IN_KEY', '\\\$LOGGED_IN_KEY' );/g\" \"${file}'\"")
                Shell.shOrFail("sed -i \"s/define( 'NONCE_KEY',\\s*'put your unique phrase here' );/define( 'NONCE_KEY', '\\\$NONCE_KEY' );/g\" \"${file}'\"")
                Shell.shOrFail("sed -i \"s/define( 'AUTH_SALT',\\s*'put your unique phrase here' );/define( 'AUTH_SALT', '\\\$AUTH_SALT' );/g\" \"${file}'\"")
                Shell.shOrFail("sed -i \"s/define( 'SECURE_AUTH_SALT',\\s*'put your unique phrase here' );/define( 'SECURE_AUTH_SALT', '\\\$SECURE_AUTH_SALT' );/g\" \"${file}'\"")
                Shell.shOrFail("sed -i \"s/define( 'LOGGED_IN_SALT',\\s*'put your unique phrase here' );/define( 'LOGGED_IN_SALT', '\\\$LOGGED_IN_SALT' );/g\" \"${file}'\"")
                Shell.shOrFail("sed -i \"s/define( 'NONCE_SALT',\\s*'put your unique phrase here' );/define( 'NONCE_SALT', '\\\$NONCE_SALT' );/g\" \"${file}'\"")
            }
        }
        stage('Docker Build') {
            steps {
                echo("Копирую зависимые файлы контейнера...")
                Shell.shOrFail("cp -r 'src/job_build_wordpress_for_docker/Dockerfile' '${wordpressChosenReleaseName}/'")
                Shell.shOrFail("cp -r 'src/job_build_wordpress_for_docker/httpd' '${wordpressChosenReleaseName}/'")
                Shell.shOrFail("cp -r 'src/job_build_wordpress_for_docker/scripts' '${wordpressChosenReleaseName}/'")

                script {
                    echo("Собираю контейнер...")
                    imageVersion = regexGroup(wordpressChosenReleaseName, "([0-9\\.]+)") + "-" + env.BUILD_NUMBER
                    imageFullName = imageName + ":" + imageVersion
                    withCredentials([string(credentialsId: hostCredentials, variable: "host"), sshUserPrivateKey(credentialsId: sshCredentials, keyFileVariable: "id_rsa", usernameVariable: "user")]) {
                        Docker.dockerConnect(env.host, env.user, env.id_rsa, () -> {
                            if (useCache) {
                                Docker.build(imageFullName, wordpressChosenReleaseName, true)
                            } else {
                                Docker.build(imageFullName, wordpressChosenReleaseName, false)
                            }
                            // latest
                            Docker.tag(imageFullName, imageName)
                        })
                    }
                }
            }
        }
        stage("Docker Deploy") {
            steps {
                echo("Развёртываю контейнер...")
                script {
                    String result = null
                    List<String> containerIds = null
                    withCredentials([string(credentialsId: hostCredentials, variable: "host"), sshUserPrivateKey(credentialsId: sshCredentials, keyFileVariable: "id_rsa", usernameVariable: "user")]) {
                        Shell.sshConnect(env.host, env.user, env.id_rsa, () -> {
                            // Форматированный конфиг для скачивания
                            String dockerComposeYml = DockerCompose.config(dockerComposeProjectDirectory)
                            writeFile(file: "docker-compose.yml", text: dockerComposeYml)

                            // Деплой
                            DockerCompose.down(dockerComposeProjectDirectory)
                            DockerCompose.up(dockerComposeProjectDirectory)
                            Thread.sleep(10000)
                            DockerCompose.logs(dockerComposeProjectDirectory)

                            result = DockerCompose.ps(dockerComposeProjectDirectory, true)
                            containerIds = new ArrayList<>()
                            containerIds.addAll(result.split("\n"))
                            containerIds.remove("")
                            echo("Развёрнуто ${containerIds.size()} контейнеров")
                        })
                    }
                }
            }
        }
        stage("Docker Test") {
            steps {
                script {
                    if (testImage) {
                        echo("Начинаю тестирование...")
                        String result = null
                        List<String> containerIds = null
                        withCredentials([string(credentialsId: hostCredentials, variable: "host"), sshUserPrivateKey(credentialsId: sshCredentials, keyFileVariable: "id_rsa", usernameVariable: "user")]) {
                            Shell.sshConnect(env.host, env.user, env.id_rsa, () -> {
                                echo("Тест: Перезагрузка")
                                DockerCompose.restart(dockerComposeProjectDirectory)
                                Thread.sleep(10000)
                                result = DockerCompose.ps(dockerComposeProjectDirectory, true)
                                containerIds = new ArrayList<>()
                                containerIds.addAll(result.split("\n"))
                                containerIds.remove("")
                                echo("Развёрнуто ${containerIds.size()} контейнеров")
                            })
                        }
                    } else {
                        echo("Пропускаю тестирование...")
                    }

                    echo("Завершаю тестирование...")
                    withCredentials([string(credentialsId: hostCredentials, variable: "host"), sshUserPrivateKey(credentialsId: sshCredentials, keyFileVariable: "id_rsa", usernameVariable: "user")]) {
                        Shell.sshConnect(env.host, env.user, env.id_rsa, () -> {
                            DockerCompose.down(dockerComposeProjectDirectory)
                        })
                    }
                }
            }
        }
        stage("Docker Save") {
            steps {
                cleanWs(patterns: [[pattern: "${imageName}:*.tar", type: "INCLUDE"]])

                script {
                    if (exportImage) {
                        echo("Экспортирую образ...")
                        withCredentials([string(credentialsId: hostCredentials, variable: "host"), sshUserPrivateKey(credentialsId: sshCredentials, keyFileVariable: "id_rsa", usernameVariable: "user")]) {
                            Docker.dockerConnect(env.host, env.user, env.id_rsa, () -> {
                                Docker.save(imageFullName, imageFullName + ".tar")
                            })
                        }
                    }
                }

                script {
                    if (deleteImage) {
                        echo("Удаляю образ...")
                        withCredentials([string(credentialsId: hostCredentials, variable: "host"), sshUserPrivateKey(credentialsId: sshCredentials, keyFileVariable: "id_rsa", usernameVariable: "user")]) {
                            Docker.dockerConnect(env.host, env.user, env.id_rsa, () -> {
                                Docker.rmi(imageFullName)
                            })
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            cleanWs(deleteDirs: true, patterns: [[pattern: "wordpress*", type: "INCLUDE"],
                                                 [pattern: "*.html", type: "EXCLUDE"],
                                                 [pattern: "*.tar", type: "EXCLUDE"],
                                                 [pattern: "*.tar.gz", type: "EXCLUDE"],
                                                 [pattern: "*.tar.xz", type: "EXCLUDE"],
                                                 [pattern: "*.zip", type: "EXCLUDE"],
                                                 [pattern: "src", type: "EXCLUDE"]])
        }
    }
}